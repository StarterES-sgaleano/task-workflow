# API Specification - Phase 1

## Overview

The API is automatically generated by Supabase based on the database schema, providing both REST and GraphQL endpoints. All endpoints require authentication and automatically enforce Row Level Security.

## Authentication

### Headers Required
```
Authorization: Bearer <jwt_token>
apikey: <supabase_anon_key>
Content-Type: application/json
```

### Authentication Flow
1. Sign up/Sign in via Supabase Auth
2. Receive JWT token
3. Include token in all API requests
4. Token automatically validates user and enforces RLS

## REST API Endpoints

### Base URL
```
https://<project-id>.supabase.co/rest/v1/
```

### User Profile Management

#### Get User Profile
```http
GET /profiles?id=eq.<user_id>
```

#### Update User Profile
```http
PATCH /profiles?id=eq.<user_id>
Content-Type: application/json

{
  "username": "new_username",
  "full_name": "New Full Name",
  "preferences": {
    "theme": "dark",
    "notifications": true
  }
}
```

### Project Management

#### List Projects
```http
GET /projects?select=*&order=created_at.desc
```

#### Create Project
```http
POST /projects
Content-Type: application/json

{
  "name": "New Project",
  "description": "Project description",
  "color": "#3b82f6"
}
```

#### Update Project
```http
PATCH /projects?id=eq.<project_id>
Content-Type: application/json

{
  "name": "Updated Project Name",
  "description": "Updated description"
}
```

#### Archive Project
```http
PATCH /projects?id=eq.<project_id>
Content-Type: application/json

{
  "is_archived": true
}
```

### Item Management (Tasks & Documents)

#### List Items
```http
# All items
GET /items?select=*&order=updated_at.desc

# Filter by type
GET /items?type=eq.task&select=*&order=updated_at.desc
GET /items?type=eq.document&select=*&order=updated_at.desc

# Filter by project
GET /items?project_id=eq.<project_id>&select=*&order=updated_at.desc

# Filter by status (tasks only)
GET /items?status=eq.todo&select=*&order=updated_at.desc
```

#### Create Task
```http
POST /items
Content-Type: application/json

{
  "type": "task",
  "title": "New Task",
  "content": "Task description",
  "status": "todo",
  "project_id": "<project_id>",
  "metadata": {
    "priority": "high",
    "tags": ["urgent", "bug"]
  }
}
```

#### Create Document
```http
POST /items
Content-Type: application/json

{
  "type": "document",
  "title": "New Document",
  "content": "Document content with @mentions",
  "project_id": "<project_id>",
  "metadata": {
    "document_type": "notes",
    "tags": ["meeting", "planning"]
  }
}
```

#### Update Item
```http
PATCH /items?id=eq.<item_id>
Content-Type: application/json

{
  "title": "Updated Title",
  "content": "Updated content",
  "status": "in_progress"
}
```

#### Delete Item
```http
DELETE /items?id=eq.<item_id>
```

### Mention Management

#### List Mentions for Item
```http
# Get items that mention this item
GET /mentions?target_item_id=eq.<item_id>&select=*,source_item:items!source_item_id(*)

# Get items mentioned by this item
GET /mentions?source_item_id=eq.<item_id>&select=*,target_item:items!target_item_id(*)
```

#### Create Mention
```http
POST /mentions
Content-Type: application/json

{
  "source_item_id": "<source_item_id>",
  "target_item_id": "<target_item_id>",
  "mention_text": "@Task Name"
}
```

#### Delete Mention
```http
DELETE /mentions?source_item_id=eq.<source_id>&target_item_id=eq.<target_id>
```

### Activity Log

#### Get Activity for Item
```http
GET /activity_log?item_id=eq.<item_id>&select=*&order=created_at.desc
```

#### Get Recent Activity
```http
GET /activity_log?select=*&order=created_at.desc&limit=50
```

## Real-time Subscriptions

### Supabase Realtime Channels

#### Subscribe to User's Items
```javascript
const channel = supabase
  .channel('user-items')
  .on('postgres_changes', {
    event: '*',
    schema: 'public',
    table: 'items',
    filter: `user_id=eq.${userId}`
  }, (payload) => {
    console.log('Item changed:', payload)
  })
  .subscribe()
```

#### Subscribe to Project Items
```javascript
const channel = supabase
  .channel('project-items')
  .on('postgres_changes', {
    event: '*',
    schema: 'public',
    table: 'items',
    filter: `project_id=eq.${projectId}`
  }, (payload) => {
    console.log('Project item changed:', payload)
  })
  .subscribe()
```

#### Subscribe to Mentions
```javascript
const channel = supabase
  .channel('user-mentions')
  .on('postgres_changes', {
    event: '*',
    schema: 'public',
    table: 'mentions',
    filter: `user_id=eq.${userId}`
  }, (payload) => {
    console.log('Mention changed:', payload)
  })
  .subscribe()
```

## Search API

### Full-text Search
```http
# Search across all items
GET /items?or=(title.ilike.*search_term*,content.ilike.*search_term*)&select=*

# Advanced search with PostgreSQL full-text search
GET /rpc/search_items
Content-Type: application/json

{
  "search_query": "search terms",
  "item_type": "task",
  "project_id": "<project_id>"
}
```

### Search RPC Function
```sql
-- Custom search function to be created
CREATE OR REPLACE FUNCTION search_items(
  search_query text,
  item_type item_type DEFAULT NULL,
  project_id uuid DEFAULT NULL
)
RETURNS TABLE (
  id uuid,
  title text,
  content text,
  type item_type,
  status task_status,
  project_id uuid,
  created_at timestamptz,
  updated_at timestamptz,
  rank real
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    i.id,
    i.title,
    i.content,
    i.type,
    i.status,
    i.project_id,
    i.created_at,
    i.updated_at,
    ts_rank(to_tsvector('english', i.title || ' ' || i.content), plainto_tsquery('english', search_query)) as rank
  FROM items i
  WHERE 
    i.user_id = auth.uid()
    AND to_tsvector('english', i.title || ' ' || i.content) @@ plainto_tsquery('english', search_query)
    AND (item_type IS NULL OR i.type = item_type)
    AND (project_id IS NULL OR i.project_id = project_id)
  ORDER BY rank DESC, i.updated_at DESC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## Error Handling

### Standard HTTP Status Codes
- `200` - Success
- `201` - Created
- `400` - Bad Request (validation errors)
- `401` - Unauthorized (invalid/missing token)
- `403` - Forbidden (RLS policy violation)
- `404` - Not Found
- `409` - Conflict (unique constraint violation)
- `422` - Unprocessable Entity (business logic error)
- `500` - Internal Server Error

### Error Response Format
```json
{
  "error": {
    "message": "Error description",
    "details": "Additional error details",
    "hint": "Suggestion for fixing the error",
    "code": "ERROR_CODE"
  }
}
```

### Common Error Scenarios
```json
// Validation Error
{
  "error": {
    "message": "Invalid input",
    "details": "Title cannot be empty",
    "code": "VALIDATION_ERROR"
  }
}

// RLS Policy Violation
{
  "error": {
    "message": "Insufficient privileges",
    "details": "You can only access your own data",
    "code": "INSUFFICIENT_PRIVILEGE"
  }
}

// Unique Constraint Violation
{
  "error": {
    "message": "Duplicate entry",
    "details": "Username already exists",
    "code": "UNIQUE_VIOLATION"
  }
}
```

## Rate Limiting

### Supabase Rate Limits
- **Anonymous requests**: 100 requests per hour
- **Authenticated requests**: 1000 requests per hour per user
- **Real-time connections**: 100 concurrent connections per project

### Best Practices
- Implement client-side caching
- Use optimistic updates for better UX
- Batch operations when possible
- Implement exponential backoff for retries

## Data Validation

### Client-side Validation
- Title length: 1-200 characters
- Content length: unlimited (reasonable limits in UI)
- Project name: 1-100 characters
- Username: 3-30 characters, alphanumeric + underscore

### Server-side Validation
- All client-side validations enforced
- SQL constraints prevent invalid data
- RLS policies ensure data isolation
- Foreign key constraints maintain referential integrity

## Pagination

### Using Supabase Pagination
```http
# Limit and offset
GET /items?select=*&limit=20&offset=40

# Range-based pagination (preferred)
GET /items?select=*&order=created_at.desc
Range: 0-19

# Cursor-based pagination for real-time data
GET /items?select=*&order=created_at.desc&created_at=lt.2023-01-01T00:00:00Z&limit=20
```

### Response Headers
```
Content-Range: 0-19/100
```
